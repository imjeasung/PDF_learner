<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학습하기 - PDF Learner</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* 학습 페이지 전용 스타일 */
        .study-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            height: calc(100vh - 80px);
            gap: 0;
            max-width: 100%;
            margin: 0;
            padding: 0;
        }
        
        .sidebar {
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .main-content {
            display: flex;
            overflow: hidden;
            position: relative;
        }
        
        .content-area {
            background: white;
            overflow-y: auto;
            padding: 2rem;
            flex: 1;
            min-width: 300px;
        }
        
        .chat-area {
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            width: 450px;
            min-width: 300px;
            max-width: 700px;
        }
        
        .resizer {
            width: 8px;
            background: linear-gradient(90deg, #e9ecef 0%, #bdc3c7 50%, #e9ecef 100%);
            cursor: col-resize;
            position: relative;
            transition: background 0.2s ease;
            flex-shrink: 0;
        }
        
        .resizer:hover {
            background: linear-gradient(90deg, #3498db 0%, #2980b9 50%, #3498db 100%);
        }
        
        .resizer::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 3px;
            height: 30px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 2px;
        }
        
        .resizer:hover::before {
            background: rgba(255, 255, 255, 0.9);
        }
        
        /* 문서 선택 영역 */
        .document-selector {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            background: white;
        }
        
        .document-selector h3 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .document-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
            background: white;
        }
        
        .document-info {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 0.85rem;
            color: #7f8c8d;
        }
        
        /* 커리큘럼 트리 */
        .curriculum-tree {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }
        
        .curriculum-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .curriculum-header h4 {
            font-size: 1rem;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .tree-item {
            margin-bottom: 0.5rem;
        }
        
        .tree-node {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }
        
        .tree-node:hover {
            background: #f8f9fa;
            border-color: #3498db;
        }
        
        .tree-node.active {
            background: linear-gradient(45deg, #3498db, #2ecc71);
            color: white;
            border-color: #3498db;
        }
        
        .tree-node.active:hover {
            background: linear-gradient(45deg, #2980b9, #27ae60);
        }
        
        .tree-icon {
            margin-right: 0.5rem;
            width: 16px;
            text-align: center;
        }
        
        .tree-text {
            flex: 1;
            line-height: 1.4;
        }
        
        .tree-progress {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ecf0f1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            margin-left: 0.5rem;
        }
        
        .tree-progress.completed {
            background: #2ecc71;
            color: white;
        }
        
        .tree-progress.current {
            background: #3498db;
            color: white;
        }
        
        /* 콘텐츠 영역 */
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #ecf0f1;
        }
        
        .content-title {
            font-size: 2rem;
            color: #2c3e50;
            margin: 0;
        }
        
        .content-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .content-actions .btn {
            white-space: nowrap;
            font-weight: 500;
            background: #3498db !important;
            color: white !important;
            border: 2px solid #2980b9 !important;
            padding: 0.5rem 1rem !important;
            border-radius: 6px !important;
            font-size: 0.9rem !important;
            transition: all 0.3s ease !important;
            box-shadow: 0 2px 4px rgba(52, 152, 219, 0.3) !important;
            z-index: 10;
            position: relative;
        }
        
        .content-actions .btn:hover {
            background: #2980b9 !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.4) !important;
        }
        
        .section-content {
            display: none;
        }
        
        .section-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .content-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid #3498db;
        }
        
        .content-card h4 {
            font-size: 1.2rem;
            color: #2c3e50;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .summary-text {
            font-size: 1.1rem;
            line-height: 1.6;
            color: #2c3e50;
        }
        
        .keywords {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .keyword-tag {
            background: linear-gradient(45deg, #3498db, #2ecc71);
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .questions-list {
            list-style: none;
            padding: 0;
        }
        
        .questions-list li {
            background: white;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 6px;
            border-left: 3px solid #3498db;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .questions-list li:hover {
            background: #f8f9fa;
            transform: translateX(5px);
        }
        
        .question-number {
            font-weight: bold;
            color: #3498db;
            margin-right: 0.5rem;
        }
        
        /* 채팅 영역 */
        .chat-header {
            display: flex;
            justify-content: between;
            align-items: center;
            padding: 1rem;
            background: white;
            border-radius: 8px 8px 0 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .chat-header h4 {
            font-size: 1.1rem;
            color: #2c3e50;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .chat-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #2ecc71;
            animation: pulse 2s infinite;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: white;
        }
        
        .message {
            margin-bottom: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }
        
        .message.user {
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        
        .message.user .message-avatar {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }
        
        .message.ai .message-avatar {
            background: linear-gradient(45deg, #3498db, #2ecc71);
            color: white;
        }
        
        .message-content {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            line-height: 1.5;
            font-size: 0.9rem;
        }
        
        .message.user .message-content {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 12px 12px 4px 12px;
        }
        
        .message.ai .message-content {
            background: #f8f9fa;
            color: #2c3e50;
            border: 1px solid #e9ecef;
            border-radius: 12px 12px 12px 4px;
        }
        
        .message-time {
            font-size: 0.7rem;
            color: rgba(255,255,255,0.8);
            margin-top: 0.25rem;
        }
        
        .message.ai .message-time {
            color: #7f8c8d;
        }
        
        .chat-input-area {
            padding: 1rem;
            background: white;
            border-radius: 0 0 8px 8px;
            border-top: 1px solid #e9ecef;
        }
        
        .chat-input-group {
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }
        
        .chat-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 0.9rem;
            resize: none;
            max-height: 100px;
            min-height: 40px;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .chat-send-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: linear-gradient(45deg, #3498db, #2ecc71);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .chat-send-btn:hover {
            transform: scale(1.1);
        }
        
        .chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* 빈 상태 */
        .empty-content {
            text-align: center;
            padding: 3rem;
            color: #7f8c8d;
        }
        
        .empty-content i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .loading-state {
            text-align: center;
            padding: 2rem;
            color: #7f8c8d;
        }
        
        .loading-state i {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: #3498db;
        }
        
        /* 반응형 디자인 */
        @media (max-width: 1024px) {
            .study-container {
                grid-template-columns: 280px 1fr;
            }
            
            .main-content {
                grid-template-rows: 1fr 350px;
            }
        }
        
        @media (max-width: 768px) {
            .study-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
                height: auto;
                min-height: calc(100vh - 80px);
            }
            
            .sidebar {
                height: auto;
                max-height: 300px;
                border-right: none;
                border-bottom: 1px solid #e9ecef;
            }
            
            .main-content {
                flex-direction: column;
                min-height: 500px;
            }
            
            .content-area {
                width: 100% !important;
                flex: 1 !important;
                border-right: none;
                border-bottom: 1px solid #e9ecef;
            }
            
            .chat-area {
                width: 100% !important;
                flex: none !important;
            }
            
            .resizer {
                display: none;
            }
            
            .chat-area {
                height: 400px;
            }
            
            .content-area {
                padding: 1rem;
            }
            
            .content-title {
                font-size: 1.5rem;
            }
            
            .content-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .content-actions {
                width: 100%;
                justify-content: flex-start;
            }
        }
        
        /* 스크롤바 스타일링 */
        .sidebar::-webkit-scrollbar,
        .content-area::-webkit-scrollbar,
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        
        .sidebar::-webkit-scrollbar-track,
        .content-area::-webkit-scrollbar-track,
        .chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .sidebar::-webkit-scrollbar-thumb,
        .content-area::-webkit-scrollbar-thumb,
        .chat-messages::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        .sidebar::-webkit-scrollbar-thumb:hover,
        .content-area::-webkit-scrollbar-thumb:hover,
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body>
    <!-- 헤더 -->
    <header class="header">
        <div class="container">
            <div class="logo">
                <i class="fas fa-book-reader"></i>
                <h1>PDF Learner</h1>
            </div>
            <nav class="nav">
                <a href="index.html" class="nav-link">홈</a>
                <a href="upload.html" class="nav-link">업로드</a>
                <a href="study.html" class="nav-link active">학습</a>
            </nav>
        </div>
    </header>

    <!-- 메인 학습 인터페이스 -->
    <div class="study-container">
        <!-- 사이드바 -->
        <div class="sidebar">
            <!-- 문서 선택 -->
            <div class="document-selector">
                <h3><i class="fas fa-file-pdf"></i> 문서 선택</h3>
                <select class="document-select" id="document-select">
                    <option value="">문서를 선택하세요...</option>
                </select>
                <div class="document-info" id="document-info" style="display: none;">
                    <div><strong>페이지:</strong> <span id="doc-pages">-</span></div>
                    <div><strong>크기:</strong> <span id="doc-size">-</span></div>
                    <div><strong>상태:</strong> <span id="doc-status">-</span></div>
                </div>
            </div>
            
            <!-- 커리큘럼 트리 -->
            <div class="curriculum-tree">
                <div class="curriculum-header">
                    <h4><i class="fas fa-list"></i> 학습 커리큘럼</h4>
                </div>
                <div id="curriculum-tree-content">
                    <div class="empty-content">
                        <i class="fas fa-book-open"></i>
                        <p>문서를 선택하면<br>커리큘럼이 표시됩니다</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 메인 콘텐츠 -->
        <div class="main-content">
            <!-- 콘텐츠 영역 -->
            <div class="content-area">
                <div id="content-welcome" class="section-content active">
                    <div class="content-header">
                        <h2 class="content-title">📚 AI 학습 도우미</h2>
                    </div>
                    
                    <div class="empty-content">
                        <i class="fas fa-graduation-cap"></i>
                        <h3>학습을 시작해보세요!</h3>
                        <p>왼쪽에서 문서를 선택하고 커리큘럼의 섹션을 클릭하면<br>AI가 생성한 요약과 핵심 내용을 볼 수 있습니다.</p>
                        <p>아래 채팅창에서 문서에 대한 질문도 할 수 있어요!</p>
                    </div>
                </div>
                
                <div id="content-loading" class="section-content">
                    <div class="loading-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <h3>콘텐츠를 불러오는 중...</h3>
                        <p>AI가 분석한 내용을 준비하고 있습니다.</p>
                    </div>
                </div>
                
                <div id="content-section" class="section-content">
                    <!-- 동적으로 생성될 섹션 내용 -->
                </div>
            </div>
            
            <!-- 크기 조절 바 -->
            <div class="resizer" id="resizer"></div>
            
            <!-- 채팅 영역 -->
            <div class="chat-area">
                <div class="chat-header">
                    <h4><i class="fas fa-robot"></i> AI 학습 도우미</h4>
                    <div class="chat-status">
                        <span class="status-dot"></span>
                        <span>온라인</span>
                    </div>
                </div>
                
                <div class="chat-messages" id="chat-messages">
                    <div class="message ai">
                        <div class="message-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="message-content">
                            안녕하세요! 저는 PDF Learner의 AI 학습 도우미입니다. 📚<br>
                            문서에 대해 궁금한 점이 있으면 언제든 질문해주세요!
                            <div class="message-time" id="welcome-time"></div>
                        </div>
                    </div>
                </div>
                
                <div class="chat-input-area">
                    <div class="chat-input-group">
                        <textarea 
                            class="chat-input" 
                            id="chat-input" 
                            placeholder="문서에 대해 질문해보세요..."
                            rows="1"></textarea>
                        <button class="chat-send-btn" id="chat-send-btn" disabled>
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="js/script.js"></script>
    <script>
        // 학습 페이지 전용 변수
        let currentDocument = null;
        let currentCurriculum = null;
        let currentSection = null;
        let chatHistory = [];
        let isTyping = false;

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            initStudyPage();
            setupChatEvents();
            initResizer();
            
            // URL 파라미터에서 파일명 확인
            const urlParams = new URLSearchParams(window.location.search);
            const selectedFile = urlParams.get('file');
            if (selectedFile) {
                setTimeout(() => selectDocumentByName(selectedFile), 1000);
            }
        });

        // 학습 페이지 초기화
        async function initStudyPage() {
            try {
                await loadDocumentList();
                setWelcomeTime();
            } catch (error) {
                console.error('Study page initialization failed:', error);
                showMessage('페이지 초기화 중 오류가 발생했습니다.', 'error');
            }
        }

        // 문서 목록 로드
        async function loadDocumentList() {
            try {
                const data = await fetchDocuments();
                const select = document.getElementById('document-select');
                
                // 기존 옵션 제거 (첫 번째 제외)
                while (select.children.length > 1) {
                    select.removeChild(select.lastChild);
                }
                
                // 처리 완료된 문서만 표시
                const processedDocs = data.files.filter(file => 
                    file.status === 'completed' || !file.status
                );
                
                if (processedDocs.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = '학습 가능한 문서가 없습니다';
                    option.disabled = true;
                    select.appendChild(option);
                    return;
                }
                
                processedDocs.forEach(file => {
                    const option = document.createElement('option');
                    option.value = file.filename;
                    option.textContent = file.filename;
                    select.appendChild(option);
                });
                
                // 문서 선택 이벤트 등록
                select.addEventListener('change', handleDocumentSelection);
                
            } catch (error) {
                console.error('Failed to load document list:', error);
                showMessage('문서 목록을 불러오는데 실패했습니다.', 'error');
            }
        }

        // URL 파라미터로 문서 선택
        function selectDocumentByName(filename) {
            const select = document.getElementById('document-select');
            const decodedFilename = decodeURIComponent(filename);
            
            // 선택 목록에서 해당 파일 찾기
            for (let option of select.options) {
                if (option.value === decodedFilename) {
                    select.value = decodedFilename;
                    handleDocumentSelection();
                    break;
                }
            }
        }

        // 문서 선택 처리
        async function handleDocumentSelection() {
            const select = document.getElementById('document-select');
            const filename = select.value;
            
            if (!filename) {
                resetStudyInterface();
                return;
            }
            
            try {
                await loadDocumentData(filename);
                updateDocumentInfo();
                await loadCurriculum(filename);
                enableChat();
                
                showMessage('문서가 로드되었습니다. 학습을 시작하세요!', 'success');
                
            } catch (error) {
                console.error('Document selection failed:', error);
                showMessage('문서를 로드하는데 실패했습니다.', 'error');
                resetStudyInterface();
            }
        }

        // 문서 데이터 로드
        async function loadDocumentData(filename) {
            // 실제 구현에서는 API 호출
            // const data = await apiCall(`/document/${encodeURIComponent(filename)}`);
            
            // 현재는 더미 데이터
            currentDocument = {
                filename: filename,
                pages: Math.floor(Math.random() * 50) + 10,
                size_mb: (Math.random() * 10 + 1).toFixed(1),
                status: 'completed'
            };
        }

        // 문서 정보 업데이트
        function updateDocumentInfo() {
            if (!currentDocument) return;
            
            document.getElementById('doc-pages').textContent = currentDocument.pages + '페이지';
            document.getElementById('doc-size').textContent = currentDocument.size_mb + ' MB';
            document.getElementById('doc-status').textContent = '분석 완료';
            document.getElementById('document-info').style.display = 'block';
        }

        // 커리큘럼 로드
        async function loadCurriculum(filename) {
            try {
                // API 호출 (배포환경 대응)
                const response = await fetch(`/curriculum/${encodeURIComponent(filename)}`);
                
                if (!response.ok) {
                    throw new Error(`커리큘럼을 찾을 수 없습니다: ${response.status}`);
                }
                
                currentCurriculum = await response.json();
                renderCurriculumTree();
                
            } catch (error) {
                console.error('Failed to load curriculum:', error);
                showCurriculumError();
            }
        }

        // 더미 커리큘럼 생성 (실제로는 API에서 받아옴)
        function generateDummyCurriculum() {
            return {
                sections: [
                    {
                        id: 'section1',
                        title: '개요 및 소개',
                        summary: '이 문서의 전반적인 개요와 주요 목적을 설명하는 섹션입니다.',
                        keywords: ['개요', '소개', '목적', '배경', '범위'],
                        questions: [
                            '이 문서의 주요 목적은 무엇인가요?',
                            '다루는 주제의 범위는 어떻게 되나요?',
                            '독자가 알아야 할 배경지식은 무엇인가요?'
                        ]
                    },
                    {
                        id: 'section2', 
                        title: '핵심 개념',
                        summary: '문서에서 다루는 핵심 개념들과 기본 원리를 설명합니다.',
                        keywords: ['핵심개념', '원리', '기초', '이론', '정의'],
                        questions: [
                            '가장 중요한 핵심 개념은 무엇인가요?',
                            '이 개념들은 어떻게 서로 연관되어 있나요?',
                            '실제 적용 사례는 어떤 것들이 있나요?'
                        ]
                    },
                    {
                        id: 'section3',
                        title: '실무 적용',
                        summary: '이론적 내용을 실제 업무나 상황에 적용하는 방법을 다룹니다.',
                        keywords: ['실무', '적용', '응용', '실습', '사례'],
                        questions: [
                            '실무에서 어떻게 활용할 수 있나요?',
                            '주의해야 할 점은 무엇인가요?',
                            '성공적인 적용 사례는 어떤 것들이 있나요?'
                        ]
                    },
                    {
                        id: 'section4',
                        title: '결론 및 요약',
                        summary: '문서의 주요 내용을 정리하고 결론을 제시합니다.',
                        keywords: ['결론', '요약', '정리', '시사점', '향후과제'],
                        questions: [
                            '이 문서의 핵심 메시지는 무엇인가요?',
                            '향후 어떤 발전 방향이 제시되나요?',
                            '독자가 취해야 할 행동은 무엇인가요?'
                        ]
                    }
                ]
            };
        }

        // 커리큘럼 트리 렌더링
        function renderCurriculumTree() {
            const container = document.getElementById('curriculum-tree-content');
            
            if (!currentCurriculum || !currentCurriculum.structure) {
                container.innerHTML = `
                    <div class="empty-content">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>커리큘럼을 불러올 수 없습니다</p>
                    </div>
                `;
                return;
            }
            
            const treeHtml = currentCurriculum.structure.map((section, index) => `
                <div class="tree-item">
                    <div class="tree-node" onclick="selectSection('${section.section_id}')">
                        <i class="fas fa-book tree-icon"></i>
                        <div class="tree-text">${section.title}</div>
                        <div class="tree-progress" id="progress-${section.section_id}">
                            ${index + 1}
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = treeHtml;
        }

        // 섹션 선택
        function selectSection(sectionId) {
            if (!currentCurriculum) return;
            
            const section = currentCurriculum.structure.find(s => s.section_id === sectionId);
            const sectionContent = currentCurriculum.content[sectionId];
            if (!section || !sectionContent) return;
            
            currentSection = section;
            
            // 트리에서 활성 상태 업데이트
            document.querySelectorAll('.tree-node').forEach(node => {
                node.classList.remove('active');
            });
            
            const selectedNode = document.querySelector(`[onclick="selectSection('${sectionId}')"]`);
            if (selectedNode) {
                selectedNode.classList.add('active');
            }
            
            // 진행 상태 업데이트
            const progressEl = document.getElementById(`progress-${sectionId}`);
            if (progressEl) {
                progressEl.classList.add('current');
                progressEl.innerHTML = '<i class="fas fa-eye"></i>';
            }
            
            // 콘텐츠 표시
            showSectionContent(section, sectionContent);
        }

        // 섹션 콘텐츠 표시
        function showSectionContent(section, sectionContent) {
            // 모든 섹션 숨기기
            document.querySelectorAll('.section-content').forEach(el => {
                el.classList.remove('active');
            });
            
            // 로딩 표시
            document.getElementById('content-loading').classList.add('active');
            
            // 콘텐츠 생성 (실제로는 API에서 받아옴)
            setTimeout(() => {
                const contentHtml = `
                    <div class="content-header">
                        <h2 class="content-title">${section.title}</h2>
                        <div class="content-actions">
                            <button class="btn btn-small btn-secondary" onclick="markAsCompleted('${section.section_id}')">
                                <i class="fas fa-check"></i> 완료 표시
                            </button>
                        </div>
                    </div>
                    
                    <div class="content-card">
                        <h4><i class="fas fa-file-alt"></i> 요약</h4>
                        <div class="summary-text">${sectionContent.summary || '요약 정보가 없습니다.'}</div>
                    </div>
                    
                    <div class="content-card">
                        <h4><i class="fas fa-tags"></i> 핵심 키워드</h4>
                        <div class="keywords">
                            ${(sectionContent.keywords || []).map(keyword => 
                                `<span class="keyword-tag">${keyword}</span>`
                            ).join('')}
                        </div>
                    </div>
                    
                    <div class="content-card">
                        <h4><i class="fas fa-question-circle"></i> 예상 질문</h4>
                        <ul class="questions-list">
                            ${(sectionContent.questions || []).map((question, index) => 
                                `<li onclick="askQuestion('${question}')">
                                    <span class="question-number">Q${index + 1}.</span>
                                    ${question}
                                </li>`
                            ).join('')}
                        </ul>
                    </div>
                `;
                
                document.getElementById('content-section').innerHTML = contentHtml;
                document.getElementById('content-loading').classList.remove('active');
                document.getElementById('content-section').classList.add('active');
                
            }, 800);
        }

        // 섹션 완료 표시
        function markAsCompleted(sectionId) {
            const progressEl = document.getElementById(`progress-${sectionId}`);
            if (progressEl) {
                progressEl.classList.remove('current');
                progressEl.classList.add('completed');
                progressEl.innerHTML = '<i class="fas fa-check"></i>';
            }
            
            showMessage('섹션을 완료로 표시했습니다!', 'success');
        }

        // 채팅 이벤트 설정
        function setupChatEvents() {
            const chatInput = document.getElementById('chat-input');
            const sendBtn = document.getElementById('chat-send-btn');
            
            chatInput.addEventListener('input', function() {
                sendBtn.disabled = !this.value.trim() || isTyping;
            });
            
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (!sendBtn.disabled) {
                        sendMessage();
                    }
                }
            });
            
            sendBtn.addEventListener('click', sendMessage);
        }

        // 채팅 활성화
        function enableChat() {
            const chatInput = document.getElementById('chat-input');
            chatInput.placeholder = `${currentDocument.filename}에 대해 질문해보세요...`;
            chatInput.disabled = false;
        }

        // 질문 전송
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message || isTyping) return;
            
            // 사용자 메시지 표시
            addChatMessage('user', message);
            input.value = '';
            document.getElementById('chat-send-btn').disabled = true;
            
            // AI 응답 대기
            isTyping = true;
            addTypingIndicator();
            
            try {
                // API 호출 (배포환경 대응)
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        question: message,
                        document: currentDocument.filename
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const aiResponse = data.answer;
                
                setTimeout(() => {
                    removeTypingIndicator();
                    addChatMessage('ai', aiResponse);
                    isTyping = false;
                    document.getElementById('chat-send-btn').disabled = false;
                }, 1500);
                
            } catch (error) {
                removeTypingIndicator();
                addChatMessage('ai', '죄송합니다. 답변을 생성하는 중 오류가 발생했습니다.');
                isTyping = false;
                document.getElementById('chat-send-btn').disabled = false;
            }
        }

        // 예상 질문 클릭
        function askQuestion(question) {
            const input = document.getElementById('chat-input');
            input.value = question;
            input.focus();
            document.getElementById('chat-send-btn').disabled = false;
        }

        // 채팅 메시지 추가
        function addChatMessage(type, message) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ko-KR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            messageEl.innerHTML = `
                <div class="message-avatar">
                    <i class="fas fa-${type === 'user' ? 'user' : 'robot'}"></i>
                </div>
                <div class="message-content">
                    ${message}
                    <div class="message-time">${timeStr}</div>
                </div>
            `;
            
            messagesContainer.appendChild(messageEl);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // 타이핑 표시 추가
        function addTypingIndicator() {
            const messagesContainer = document.getElementById('chat-messages');
            const typingEl = document.createElement('div');
            typingEl.id = 'typing-indicator';
            typingEl.className = 'message ai';
            typingEl.innerHTML = `
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content">
                    <i class="fas fa-spinner fa-spin"></i> AI가 답변을 생각하고 있습니다...
                </div>
            `;
            
            messagesContainer.appendChild(typingEl);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // 타이핑 표시 제거
        function removeTypingIndicator() {
            const typingEl = document.getElementById('typing-indicator');
            if (typingEl) {
                typingEl.remove();
            }
        }

        // AI 응답 생성 (더미)
        async function generateAIResponse(question) {
            const responses = [
                '좋은 질문이네요! 문서에 따르면...',
                '해당 내용에 대해 설명드리겠습니다.',
                '문서의 관련 부분을 찾아보니...',
                '이 주제에 대해서는 다음과 같이 설명되어 있습니다.',
                '흥미로운 질문입니다. 문서에서는...'
            ];
            
            const randomResponse = responses[Math.floor(Math.random() * responses.length)];
            return randomResponse + ' (실제 구현에서는 AI가 문서 내용을 기반으로 정확한 답변을 제공합니다.)';
        }

        // 크기 조절 바 초기화
        function initResizer() {
            const resizer = document.getElementById('resizer');
            const contentArea = document.querySelector('.content-area');
            const chatArea = document.querySelector('.chat-area');
            const mainContent = document.querySelector('.main-content');
            
            let isResizing = false;
            let startX = 0;
            let startContentWidth = 0;
            let startChatWidth = 0;
            
            resizer.addEventListener('mousedown', function(e) {
                isResizing = true;
                startX = e.clientX;
                
                const contentRect = contentArea.getBoundingClientRect();
                const chatRect = chatArea.getBoundingClientRect();
                
                startContentWidth = contentRect.width;
                startChatWidth = chatRect.width;
                
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;
                
                const deltaX = e.clientX - startX;
                const mainContentWidth = mainContent.getBoundingClientRect().width - 8; // 리사이저 폭 제외
                
                let newContentWidth = startContentWidth + deltaX;
                let newChatWidth = startChatWidth - deltaX;
                
                // 최소/최대 크기 제한
                const minContentWidth = 300;
                const minChatWidth = 300;
                const maxChatWidth = 700;
                
                if (newContentWidth < minContentWidth) {
                    newContentWidth = minContentWidth;
                    newChatWidth = mainContentWidth - newContentWidth;
                }
                
                if (newChatWidth < minChatWidth) {
                    newChatWidth = minChatWidth;
                    newContentWidth = mainContentWidth - newChatWidth;
                }
                
                if (newChatWidth > maxChatWidth) {
                    newChatWidth = maxChatWidth;
                    newContentWidth = mainContentWidth - newChatWidth;
                }
                
                // 스타일 적용
                contentArea.style.width = newContentWidth + 'px';
                chatArea.style.width = newChatWidth + 'px';
                contentArea.style.flex = 'none';
                chatArea.style.flex = 'none';
                
                e.preventDefault();
            });
            
            document.addEventListener('mouseup', function() {
                if (isResizing) {
                    isResizing = false;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });
        }

        // 인터페이스 초기화
        function resetStudyInterface() {
            currentDocument = null;
            currentCurriculum = null;
            currentSection = null;
            
            document.getElementById('document-info').style.display = 'none';
            document.getElementById('curriculum-tree-content').innerHTML = `
                <div class="empty-content">
                    <i class="fas fa-book-open"></i>
                    <p>문서를 선택하면<br>커리큘럼이 표시됩니다</p>
                </div>
            `;
            
            document.querySelectorAll('.section-content').forEach(el => {
                el.classList.remove('active');
            });
            document.getElementById('content-welcome').classList.add('active');
            
            const chatInput = document.getElementById('chat-input');
            chatInput.placeholder = '문서를 선택한 후 질문해보세요...';
            chatInput.disabled = true;
        }

        // 환영 메시지 시간 설정
        function setWelcomeTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ko-KR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            document.getElementById('welcome-time').textContent = timeStr;
        }

        // 커리큘럼 오류 표시
        function showCurriculumError() {
            document.getElementById('curriculum-tree-content').innerHTML = `
                <div class="empty-content">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>커리큘럼을 불러오는데<br>실패했습니다</p>
                    <button class="btn btn-small btn-primary" onclick="loadCurriculum(currentDocument.filename)">
                        다시 시도
                    </button>
                </div>
            `;
        }
    </script>
</body>
</html>
